{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}{% endblock %}</title>

    <link rel="stylesheet" href="{% static 'base.css' %}">
    <link rel="stylesheet" href="{% static 'messages.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>

<body>
    <header>
        <a href="{% url 'venue_list' %}" class="site-title">
            {% include "includes/logo.svg.html" %}
        </a>
        <nav class="main-nav">
            {% if user.is_authenticated %}
                <div class="user-menu">
                    {% if user.is_authenticated and user.user_type == 'venue_admin' and venue_id %}
                        <a href="{% url 'venue_dashboard' venue_id %}" class="dashboard-link">Dashboard</a>
                    {% endif %}

                    <button class="user-menu-btn" id="userMenuBtn">
                        {{ user.username }}
                        <span class="triangle">&#x25BC;</span>
                    </button>

                    <div class="user-dropdown" id="userDropdown" role="menu" aria-labelledby="userMenuBtn">
                        <a href="{% url 'profile' %}" role="menuitem">Profile</a>

                        <!-- Settings with vertical submenu -->
                        <div class="submenu">
                            <button class="submenu-btn" type="button">
                                Settings <span class="triangle">&#x25BC;</span>
                            </button>
                            <div class="submenu-content">
                                <div class="theme-toggle-container">
                                    <span class="theme-label">Dark Mode</span>

                                    <!-- styled switch; checkbox has id so JS can find it -->
                                    <label class="switch" aria-label="Toggle dark mode">
                                    <input type="checkbox" id="theme-toggle" aria-checked="false" />
                                    <span class="slider round" role="switch" aria-hidden="true"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <form method="post" action="{% url 'logout' %}" class="logout-form" role="none">
                            {% csrf_token %}
                            <button type="submit" class="logout-link" role="menuitem">Logout</button>
                        </form>

                        <a href="{% url 'my_reservations' %}" role="menuitem">My Reservations</a>
                    </div>
                </div>
            {% else %}
                <a href="{% url 'apply_venue' %}" class="apply-venue-btn">Apply to Register a Venue</a>
                <span class="separator">|</span>
                <a href="{% url 'login' %}" class="nav-link">Login</a>
                <span class="separator">|</span>
                <a href="{% url 'signup' %}" class="nav-link">Sign Up</a>
            {% endif %}
        </nav>
    </header>

    <main>
        {% include 'includes/messages.html' %}
        {% block content %}{% endblock %}
    </main>

    <footer>
        &copy; 2025 OpenSpots. All rights reserved.
    </footer>

    <!-- âœ… All JS at bottom -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const body = document.body;
            const themeToggle = document.getElementById("theme-toggle");
            const userMenuBtn = document.getElementById("userMenuBtn");
            const userDropdown = document.getElementById("userDropdown");
            const userTriangle = userMenuBtn?.querySelector(".triangle");
            const submenuBtn = document.querySelector(".submenu-btn");
            const submenu = document.querySelector(".submenu");

            // User dropdown toggle
            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener("click", e => {
                    e.stopPropagation();
                    userDropdown.classList.toggle("show");
                    userTriangle?.classList.toggle("rotate");
                });

                document.addEventListener("click", () => {
                    userDropdown.classList.remove("show");
                    userTriangle?.classList.remove("rotate");
                });

                userDropdown.addEventListener("click", e => e.stopPropagation());
            }

            // Submenu toggle
            if (submenuBtn && submenu) {
                submenuBtn.addEventListener("click", e => {
                    e.stopPropagation();
                    submenu.classList.toggle("open");
                });
            }

            // Theme toggle
            if (localStorage.getItem("theme") === "dark") {
                body.classList.add("dark-theme");
                if (themeToggle) themeToggle.checked = true;
            }

            themeToggle?.addEventListener("change", () => {
                body.classList.toggle("dark-theme", themeToggle.checked);
                localStorage.setItem("theme", themeToggle.checked ? "dark" : "light");
            });

            // Fade out alerts
            document.querySelectorAll('.fade-message').forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.style.display = 'none', 600);
                }, 2000);
            });
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
