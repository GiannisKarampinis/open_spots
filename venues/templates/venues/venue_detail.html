{% extends 'includes/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ venue.name }} - OpenSpots{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'venues/venue_detail.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block content %}

<!-- HERO SECTION -->
<div class="hero-section" style="background-image:url('{% if venue.image %}{{ venue.image.url }}{% endif %}')">
  <div class="hero-overlay"></div>
  <div class="hero-title">
    <h1>{{ venue.name }}</h1>
    <p>{{ venue.location }}</p>
  </div>
</div>

<div class="page-container">

  <!-- LEFT SIDE -->
  <div>

    <!-- TABS -->
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="about">{% trans "About" %}</div>
      <div class="tab" data-tab="menu">{% trans "Menu" %}</div>
      <div class="tab" data-tab="photos">{% trans "Photos" %}</div>
      <div class="tab" data-tab="reviews">{% trans "Reviews" %}</div>
    </div>

    <!-- ABOUT SECTION -->
    <div class="tab-content active" id="about">
      <p class="venue-description">{{ venue.description }}</p>
      <h3>{% trans "Location" %}</h3>
      <div id="venue-map"></div>
    </div>

    <!-- MENU SECTION -->
    <div class="tab-content" id="menu">
      <h3>{% trans "Menu" %}</h3>
      <p>{% trans "This venue has not added a menu yet." %}</p>
    </div>

    <!-- PHOTOS SECTION -->
    <div class="tab-content" id="photos">
      <h3>{% trans "Photos" %}</h3>
      <div class="gallery">
        {% for image in venue.gallery_images.all %}
          <img src="{{ image.image.url }}" alt="Photo">
        {% empty %}
          <p>{% trans "No photos available." %}</p>
        {% endfor %}
      </div>
    </div>

    <!-- REVIEWS SECTION -->
    <div class="tab-content" id="reviews">
      <h3>{% trans "Reviews" %}</h3>
      <div class="reviews">
        {% for review in venue.reviews.all %}
          <div class="review-card">
            <strong>{{ review.user.username }}</strong>
            <div class="stars">★★★★★</div>
            <p>{{ review.comment }}</p>
          </div>
        {% empty %}
          <p>{% trans "No reviews yet." %}</p>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- RIGHT SIDE RESERVATION CARD -->
  <div>
    <div class="reserve-card">
      <h3>{% trans "Reserve a Table" %}</h3>

      {% if user.is_authenticated %}

      <div id="reservation-steps">

        <!-- STEP TABS -->
        <div class="res-steps-tabs">
          <div class="res-step-tab active" data-step="1">
            <i class="fa fa-user"></i> {% trans "Personal Info" %}
          </div>
          <div class="res-step-tab disabled" data-step="2">
            <i class="fa fa-clock"></i> {% trans "Date & Time" %}
          </div>
          <div class="res-step-tab disabled" data-step="3">
            <i class="fa fa-comment"></i> {% trans "Notes" %}
          </div>
        </div>

        <!-- FORM -->
        <form method="post" id="reservation-form">
          {% csrf_token %}

          <!-- STEP 1 -->
          <div class="res-step active" id="step-1">
            <label>{% trans "Name" %}</label>
            <input name="name" type="text" class="res-input" required>

            <label>{% trans "Email" %}</label>
            <input name="email" type="email" class="res-input" required>

            <label>{% trans "Phone" %}</label>
            <input name="phone" type="text" class="res-input" required>

            <button type="button" class="res-next-btn" data-next="2">{% trans "Next" %}</button>
          </div>

          <!-- STEP 2 -->
          <div class="res-step" id="step-2">
            <label>{% trans "Date" %}</label>
            <input name="date" type="date" class="res-input" required>

            <label>{% trans "Time" %}</label>
            <input name="time" type="time" class="res-input" required>

            <label>{% trans "Guests" %}</label>
            <input name="guests" type="number" min="1" max="20" class="res-input" required>

            <div class="res-step-actions">
              <button type="button" class="res-prev-btn" data-prev="1">{% trans "Back" %}</button>
              <button type="button" class="res-next-btn" data-next="3">{% trans "Next" %}</button>
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="res-step" id="step-3">
            <label>{% trans "Special Requests" %}</label>
            <textarea name="special_requests" class="res-textarea"></textarea>

            <label>{% trans "Allergies" %}</label>
            <textarea name="allergies" class="res-textarea"></textarea>

            <label>{% trans "Comments" %}</label>
            <textarea name="comments" class="res-textarea"></textarea>

            <div class="res-step-actions">
              <button type="button" class="res-prev-btn" data-prev="2">{% trans "Back" %}</button>
              <button type="submit" class="res-submit-btn">{% trans "Submit Reservation" %}</button>
            </div>
          </div>

        </form>

      </div>

      {% else %}
      <a class="btn btn-success w-100" href="{% url 'account_login' %}?next={{ request.path }}">
        {% trans "Log in to reserve" %}
      </a>
      {% endif %}
    </div>
  </div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

{{ venue.latitude|default:"null"|json_script:"venue_lat" }}
{{ venue.longitude|default:"null"|json_script:"venue_lng" }}

<script>
// MAP INIT
const lat = JSON.parse(document.getElementById("venue_lat").textContent);
const lng = JSON.parse(document.getElementById("venue_lng").textContent);
if (lat && lng) {
  const map = L.map('venue-map').setView([lat, lng], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  L.marker([lat, lng]).addTo(map);
}

// LEFT SIDE TABS
const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    contents.forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// RESERVATION MULTI-STEP FORM
const resTabs = document.querySelectorAll('.res-step-tab');
const resSteps = document.querySelectorAll('.res-step');
const nextBtns = document.querySelectorAll('.res-next-btn');
const prevBtns = document.querySelectorAll('.res-prev-btn');

function showResStep(stepNumber) {
  resSteps.forEach(s => s.classList.remove('active'));
  resTabs.forEach(t => t.classList.remove('active'));
  document.querySelector(`#step-${stepNumber}`).classList.add('active');
  document.querySelector(`.res-step-tab[data-step="${stepNumber}"]`).classList.add('active');
}

nextBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const next = btn.dataset.next;
    const currentStep = btn.closest('.res-step');
    const inputs = currentStep.querySelectorAll('input[required], textarea[required]');
    for (let input of inputs) {
      if (!input.value.trim()) {
        input.classList.add("input-error");
        return;
      }
      input.classList.remove("input-error");
    }
    document.querySelector(`.res-step-tab[data-step="${next}"]`).classList.remove("disabled");
    showResStep(next);
  });
});

prevBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const prev = btn.dataset.prev;
    showResStep(prev);
  });
});

resTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.classList.contains('disabled')) return;
    showResStep(tab.dataset.step);
  });
});
</script>

{% endblock %}
