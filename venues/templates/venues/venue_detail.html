{% extends 'includes/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ venue.name }} - OpenSpots{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'venues/venue_detail.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block content %}

<!-- HERO SECTION -->
<div class="hero-section" style="background-image:url('{% if venue.image %}{{ venue.image.url }}{% endif %}')">
  <div class="hero-overlay"></div>
  <div class="hero-title">
    <h1>{{ venue.name }}</h1>
    <p>{{ venue.location }}</p>
  </div>
</div>

<div class="page-container">

  <!-- LEFT SIDE -->
  <div>
    <!-- TABS -->
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="about">{% trans "About" %}</div>
      <div class="tab" data-tab="menu">{% trans "Menu" %}</div>
      <div class="tab" data-tab="photos">{% trans "Photos" %}</div>
      <div class="tab" data-tab="reviews">{% trans "Reviews" %}</div>
    </div>

    <!-- ABOUT SECTION -->
    <div class="tab-content active" id="about">
      <p class="venue-description">{{ venue.description }}</p>
      <h3>{% trans "Location" %}</h3>
      <div id="venue-map"></div>
    </div>

    <!-- MENU SECTION -->
    <div class="tab-content" id="menu">
      <h3>{% trans "Menu" %}</h3>
      <p>{% trans "This venue has not added a menu yet." %}</p>
    </div>

    <!-- PHOTOS SECTION -->
    <div class="tab-content" id="photos">
      <h3>{% trans "Photos" %}</h3>
      <div class="gallery">
        {% for image in venue.gallery_images.all %}
          <img src="{{ image.image.url }}" alt="Photo">
        {% empty %}
          <p>{% trans "No photos available." %}</p>
        {% endfor %}
      </div>
    </div>

    <!-- REVIEWS SECTION -->
    <div class="tab-content" id="reviews">
      <h3>{% trans "Reviews" %}</h3>
      <div class="reviews">
        {% for review in reviews %}
          <div class="review-card">
              <strong>{{ review.user.username }}</strong>

              <div class="review-stars">
                {% for i in "12345" %}
                    {% if forloop.counter <= review.rating %}
                        <span class="star full"></span>
                    {% else %}
                        <span class="star empty"></span>
                    {% endif %}
                {% endfor %}
              </div>

              {% if review.comment %}
                  <p>{{ review.comment }}</p>
              {% endif %}
          </div>
        {% empty %}
            <p>{% trans "No reviews yet." %}</p>
        {% endfor %}
      </div>
      <!-- REVIEW FORM -->
      <div class="review-form-container">
          <h4>Leave a Review</h4>

          <form method="POST" id="reviewForm" class="review-form">
              {% csrf_token %}

              <!-- STAR RATING -->
              <div class="review-star-group">
                  <label class="review-label">Rating <span>*</span></label>

                  <div class="star-rating">
                      <input type="radio" name="rating" id="star-5" value="5" required>
                      <label for="star-5" class="star">&#9733;</label>

                      <input type="radio" name="rating" id="star-4" value="4">
                      <label for="star-4" class="star">&#9733;</label>

                      <input type="radio" name="rating" id="star-3" value="3">
                      <label for="star-3" class="star">&#9733;</label>

                      <input type="radio" name="rating" id="star-2" value="2">
                      <label for="star-2" class="star">&#9733;</label>

                      <input type="radio" name="rating" id="star-1" value="1">
                      <label for="star-1" class="star">&#9733;</label>
                  </div>
              </div>

              <!-- OPTIONAL COMMENT -->
              <div class="review-comment-group">
                  <label class="review-label">Comment (optional)</label>
                  <textarea 
                      name="comment" 
                      rows="4" 
                      class="review-textarea" 
                      placeholder="Share your experience..."></textarea>
              </div>

              <!-- SUBMIT -->
              <button type="submit" class="review-submit-btn" name="submit_review">Submit Review</button>
          </form>
      </div>

    </div>

  </div>

  <!-- RIGHT SIDE RESERVATION CARD -->
  <div>
    <div class="reserve-card">
        <h3>Reserve a Table</h3>

        {% if user.is_authenticated %}

        <form method="POST" id="reservationForm">
            {% csrf_token %}
            
            <div class="res-steps-container">
                <!-- STEP CIRCLE TABS -->
                <div class="res-tabs">
                    <button type="button" class="res-tab active" data-step="1">
                    <i class="fa fa-user"></i>
                    </button>
                    <button type="button" class="res-tab disabled" data-step="2">
                    <i class="fa fa-clock"></i>
                    </button>
                    <button type="button" class="res-tab disabled" data-step="3">
                    <i class="fa fa-comment"></i>
                    </button>
                </div>

            <!-- STEP 1: Personal Info -->
            <div class="res-step active" data-step="1">
                <h3>Your Information</h3>
                {{ form.name.label_tag }}  
                {{ form.name }}
                {{ form.name.errors }}

                {{ form.email.label_tag }}
                {{ form.email }}
                {{ form.email.errors }}

                {{ form.phone.label_tag }}
                {{ form.phone }}
                {{ form.phone.errors }}

                <!--<button type="button" class="res-next-btn" data-next="2">Next</button>-->
            </div>

            <!-- STEP 2: Reservation Details -->
            <div class="res-step" data-step="2">
              <h3>Reservation Details</h3>

                {{ form.date.label_tag }}
                {{ form.date }}
                {{ form.date.errors }}

                <label for="selected-time">Time</label>
                <div id="time-slot-container" class="time-slot-container"></div>
                <input type="hidden" name="time" id="selected-time">
                {{ form.time.errors }}

                {{ form.guests.label_tag }}
                {{ form.guests }}
                {{ form.guests.errors }}

              <!--<button type="button" class="res-prev-btn" data-prev="1">Back</button>-->
              <!--<button type="button" class="res-next-btn" data-next="3">Next</button>-->
          </div>


            <!-- STEP 3: Additional Notes -->
            <div class="res-step" data-step="3">
                <h3>Additional Notes</h3>
                {{ form.special_requests.label_tag }}
                {{ form.special_requests }}

                {{ form.allergies.label_tag }}
                {{ form.allergies }}

                {{ form.comments.label_tag }}
                {{ form.comments }}

                <!--<button type="button" class="res-prev-btn" data-prev="2">Back</button>-->
                <button type="submit" class="res-submit-btn" name="submit_reservation">Submit Reservation</button>
            </div>

            </div>
        </form>

        {% else %}
        <a class="btn btn-success w-100" href="{% url 'account_login' %}?next={{ request.path }}">
            Log in to reserve
        </a>
        {% endif %}
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

{{ venue.latitude|default:"null"|json_script:"venue_lat" }}
{{ venue.longitude|default:"null"|json_script:"venue_lng" }}

<script>
// ---------------------------
// MAP INITIALIZATION
// ---------------------------
const lat = JSON.parse(document.getElementById("venue_lat").textContent);
const lng = JSON.parse(document.getElementById("venue_lng").textContent);

if (lat && lng) {
  const map = L.map('venue-map').setView([lat, lng], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  L.marker([lat, lng]).addTo(map);
}

// ---------------------------
// TAB NAVIGATION (LEFT SIDE)
// ---------------------------
const leftTabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

leftTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    leftTabs.forEach(t => t.classList.remove('active'));
    tabContents.forEach(c => c.classList.remove('active'));

    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// ---------------------------
// RESERVATION MULTI-STEP FORM
// ---------------------------
document.addEventListener("DOMContentLoaded", () => {

    const steps = document.querySelectorAll(".res-step");
    const tabs = document.querySelectorAll(".res-tab");

    // ---------------------------
    // SHOW STEP
    // ---------------------------
    function showStep(stepNumber) {
        steps.forEach(s => s.classList.remove("active"));
        const step = document.querySelector(`.res-step[data-step="${stepNumber}"]`);
        step.classList.add("active");

        tabs.forEach(t => t.classList.remove("active"));
        document.querySelector(`.res-tab[data-step="${stepNumber}"]`).classList.add("active");

        // Render time slots only when Step 2 is active
        if (stepNumber == 2) renderTimeSlots();
    }

    // ---------------------------
    // VALIDATE STEP AND UNLOCK NEXT TAB
    // ---------------------------
    function validateStep(stepNumber) {
        const step = document.querySelector(`.res-step[data-step="${stepNumber}"]`);
        const inputs = step.querySelectorAll('input[required], select[required], textarea[required]');
        let allFilled = true;

        inputs.forEach(input => {
            if (!input.value.trim()) allFilled = false;
        });

        const nextTab = document.querySelector(`.res-tab[data-step="${stepNumber + 1}"]`);
        if (nextTab) {
            nextTab.classList.toggle("disabled", !allFilled);
        }
    }

    // ---------------------------
    // INPUT LISTENER
    // ---------------------------
    document.querySelectorAll('.res-step input, .res-step select').forEach(input => {
        input.addEventListener('input', () => {
            validateStep(1);
            validateStep(2);
        });
    });

    // ---------------------------
    // TAB CLICK
    // ---------------------------
    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            if (tab.classList.contains("disabled")) return;
            showStep(tab.dataset.step);
        });
    });

    // ---------------------------
    // INITIAL DISPLAY
    // ---------------------------
    showStep(1);

    // ---------------------------
    // TIME SLOT PICKER
    // ---------------------------
    function generateTimeSlots() {
        const slots = [];
        let hour = 12;
        let minute = 0;

        while (hour < 24 || (hour === 23 && minute === 30)) {
            const hh = hour.toString().padStart(2, '0');
            const mm = minute.toString().padStart(2, '0');

            const value = `${hh}:${mm}`;
            const label = new Date(`2000-01-01T${value}:00`).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
            });

            slots.push({ value, label });

            minute += 30;
            if (minute >= 60) {
                minute = 0;
                hour++;
            }
        }

        return slots;
    }

    function renderTimeSlots() {
        const container = document.getElementById("time-slot-container");
        if (!container) return;

        const hiddenInput = document.getElementById("selected-time");
        const slots = generateTimeSlots();

        container.innerHTML = "";

        slots.forEach(slot => {
            const box = document.createElement("div");
            box.classList.add("time-slot");
            box.textContent = slot.label;
            box.dataset.value = slot.value;

            if (hiddenInput.value === slot.value) box.classList.add("active");

            box.addEventListener("click", () => {
                container.querySelectorAll(".time-slot").forEach(b => b.classList.remove("active"));
                box.classList.add("active");
                hiddenInput.value = slot.value;

                // Trigger validation
                const step2Inputs = document.querySelectorAll('.res-step[data-step="2"] input[required]');
                step2Inputs.forEach(input => input.dispatchEvent(new Event('input')));
            });

            container.appendChild(box);
        });
    }
});
</script>


{% endblock %}
