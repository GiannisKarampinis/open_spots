{% extends 'includes/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ venue.name }} - OpenSpots{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'venues/venue_detail.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block content %}

<!-- HERO SECTION -->
<div class="hero-section" style="background-image:url('{% if venue.image %}{{ venue.image.url }}{% endif %}')">
  <div class="hero-overlay"></div>
  <div class="hero-title">
    <h1>{{ venue.name }}</h1>
    <p>{{ venue.location }}</p>
  </div>
</div>

<div class="page-container">

  <!-- LEFT SIDE -->
  <div>

    <!-- TABS -->
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="about">{% trans "About" %}</div>
      <div class="tab" data-tab="menu">{% trans "Menu" %}</div>
      <div class="tab" data-tab="photos">{% trans "Photos" %}</div>
      <div class="tab" data-tab="reviews">{% trans "Reviews" %}</div>
    </div>

    <!-- ABOUT SECTION -->
    <div class="tab-content active" id="about">
      <p class="venue-description">{{ venue.description }}</p>
      <h3>{% trans "Location" %}</h3>
      <div id="venue-map"></div>
    </div>

    <!-- MENU SECTION -->
    <div class="tab-content" id="menu">
      <h3>{% trans "Menu" %}</h3>
      <p>{% trans "This venue has not added a menu yet." %}</p>
    </div>

    <!-- PHOTOS SECTION -->
    <div class="tab-content" id="photos">
      <h3>{% trans "Photos" %}</h3>
      <div class="gallery">
        {% for image in venue.gallery_images.all %}
          <img src="{{ image.image.url }}" alt="Photo">
        {% empty %}
          <p>{% trans "No photos available." %}</p>
        {% endfor %}
      </div>
    </div>

    <!-- REVIEWS SECTION -->
    <div class="tab-content" id="reviews">
      <h3>{% trans "Reviews" %}</h3>
      <div class="reviews">
        {% for review in venue.reviews.all %}
          <div class="review-card">
            <strong>{{ review.user.username }}</strong>
            <div class="stars">★★★★★</div>
            <p>{{ review.comment }}</p>
          </div>
        {% empty %}
          <p>{% trans "No reviews yet." %}</p>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- RIGHT SIDE RESERVATION CARD -->
  <div>
    <div class="reserve-card">
        <h3>Reserve a Table</h3>

        {% if user.is_authenticated %}

        <form method="POST" id="reservationForm">
            {% csrf_token %}
            
            <div class="res-steps-container">
                <!-- STEP CIRCLE TABS -->
                <div class="res-tabs">
                    <button type="button" class="res-tab active" data-step="1">
                    <i class="fa fa-user"></i>
                    </button>
                    <button type="button" class="res-tab disabled" data-step="2">
                    <i class="fa fa-clock"></i>
                    </button>
                    <button type="button" class="res-tab disabled" data-step="3">
                    <i class="fa fa-comment"></i>
                    </button>
                </div>

            <!-- STEP 1: Personal Info -->
            <div class="res-step active" data-step="1">
                <h3>Your Information</h3>
                {{ form.name.label_tag }}  
                {{ form.name }}
                {{ form.name.errors }}

                {{ form.email.label_tag }}
                {{ form.email }}
                {{ form.email.errors }}

                {{ form.phone.label_tag }}
                {{ form.phone }}
                {{ form.phone.errors }}

                <button type="button" class="res-next-btn" data-next="2">Next</button>
            </div>

            <!-- STEP 2: Reservation Details -->
            <div class="res-step" data-step="2">
                <h3>Reservation Details</h3>
                {{ form.date.label_tag }}
                {{ form.date }}
                {{ form.date.errors }}

                {{ form.time.label_tag }}
                {{ form.time }}
                {{ form.time.errors }}

                {{ form.guests.label_tag }}
                {{ form.guests }}
                {{ form.guests.errors }}

                <button type="button" class="res-prev-btn" data-prev="1">Back</button>
                <button type="button" class="res-next-btn" data-next="3">Next</button>
            </div>

            <!-- STEP 3: Additional Notes -->
            <div class="res-step" data-step="3">
                <h3>Additional Notes</h3>
                {{ form.special_requests.label_tag }}
                {{ form.special_requests }}

                {{ form.allergies.label_tag }}
                {{ form.allergies }}

                {{ form.comments.label_tag }}
                {{ form.comments }}

                <button type="button" class="res-prev-btn" data-prev="2">Back</button>
                <button type="submit" class="res-submit-btn">Submit Reservation</button>
            </div>

            </div>
        </form>

        {% else %}
        <a class="btn btn-success w-100" href="{% url 'account_login' %}?next={{ request.path }}">
            Log in to reserve
        </a>
        {% endif %}
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

{{ venue.latitude|default:"null"|json_script:"venue_lat" }}
{{ venue.longitude|default:"null"|json_script:"venue_lng" }}

<script>
// MAP INIT
const lat = JSON.parse(document.getElementById("venue_lat").textContent);
const lng = JSON.parse(document.getElementById("venue_lng").textContent);
if (lat && lng) {
  const map = L.map('venue-map').setView([lat, lng], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  L.marker([lat, lng]).addTo(map);
}

// LEFT SIDE TABS
const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    contents.forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// RESERVATION MULTI-STEP FORM
document.addEventListener("DOMContentLoaded", function () {

  const steps = document.querySelectorAll(".res-step");
  const tabs = document.querySelectorAll(".res-tab");
  const nextBtns = document.querySelectorAll(".res-next-btn");
  const prevBtns = document.querySelectorAll(".res-prev-btn");

  function goToStep(step) {
    // Show step
    steps.forEach(s => s.classList.remove("active"));
    document.querySelector(`.res-step[data-step="${step}"]`).classList.add("active");

    // Highlight tab
    tabs.forEach(t => t.classList.remove("active"));
    document.querySelector(`.res-tab[data-step="${step}"]`).classList.add("active");
  }

  // Next buttons
  nextBtns.forEach(btn => {
    btn.addEventListener("click", function () {
      const next = this.getAttribute("data-next");

      // Validate required inputs in current step
      const currentStep = this.closest(".res-step");
      const inputs = currentStep.querySelectorAll("input[required], select[required], textarea[required]");
      for (let input of inputs) {
        if (!input.value.trim()) {
          input.classList.add("input-error");
          return;
        }
        input.classList.remove("input-error");
      }

      // Unlock next tab
      document.querySelector(`.res-tab[data-step="${next}"]`).classList.remove("disabled");
      goToStep(next);
    });
  });

  // Previous buttons
  prevBtns.forEach(btn => {
    btn.addEventListener("click", function () {
      const prev = this.getAttribute("data-prev");
      goToStep(prev);
    });
  });

  // Tab click
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      if (tab.classList.contains("disabled")) return;
      goToStep(tab.getAttribute("data-step"));
    });
  });

});

</script>

{% endblock %}
