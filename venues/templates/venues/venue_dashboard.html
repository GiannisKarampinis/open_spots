{% extends 'includes/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="{% static 'venues/venue_dashboard.css' %}">
{% endblock %}

{% block extra_js %}
    <!-- Load dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.257.0/dist/umd/lucide.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script src="{% static 'venues/js/analytics-tabs.js' %}"></script>
    <script src="{% static 'venues/js/notifications.js' %}"></script>
    <script src="{% static 'venues/js/reservation-actions.js' %}"></script>
    <script src="{% static 'venues/js/tables.js' %}"></script>
    <script src="{% static 'venues/js/utils.js' %}"></script>
    <script src="{% static 'venues/js/websocket.js' %}"></script>
    <script src="{% static 'venues/js/row-renderer.js' %}"></script>
    <script src="{% static 'venues/js/main.js' %}"></script>


{% endblock %}

{% block title %}Venue Dashboard{% endblock %}

{% block content %}
<div class="container mt-5" id="venue-dashboard" data-venue-id="{{ venue.id }}">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">{{ venue.name }}</h1>
        <form action="{% url 'toggle_venue_full' venue.id %}" method="post" class="venue-status-toggle">
            {% csrf_token %}
            {% if venue.is_full %}
                <span class="badge bg-danger me-2">üö´ Full</span>
                <button type="submit" class="btn btn-outline-success btn-sm mark-availability">‚úÖ Mark as Available</button>
            {% else %}
                <span class="badge bg-success me-2">‚úÖ Available</span>
                <button type="submit" class="btn btn-outline-danger btn-sm mark-availability">üö´ Mark as Full</button>
            {% endif %}
        </form>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button type="button" class="active d-flex align-items-center gap-1" data-tab="requests">
            <span data-lucide="file-text"></span> Reservation Requests & Guest Arrivals
            <span id="notification-container" class="position-relative ms-2">
                <span data-lucide="bell"></span>
                <span id="notification-badge" 
                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                    style="display:none; font-size:0.7rem;">
                    0
                </span>
            </span>
        </button>

        <button type="button" data-tab="history">
            <span data-lucide="clock"></span> Reservation History
        </button>
        <button type="button" data-tab="analytics">
            <span data-lucide="bar-chart-2"></span> Analytics
        </button>
        <button type="button" data-tab="manage-venue">
            <span data-lucide="settings-2"></span> Manage Venue
        </button>
    </div>

    <!-- Tab Contents -->
    <div class="tab-content">
        <!-- Requests Tab -->
        <div id="requests" class="active">

            <h2 class="mt-4">üìù Pending Reservation Requests</h2>
            
            <div class="table-responsive">
                <div class="datatable-controls d-flex justify-content-between mb-2">
                    <div id="upcoming-show-entries-wrapper"></div>
                    <div id="upcoming-search-wrapper"></div>
                </div>
                <table id="upcomingTable" class="table table-striped table-hover shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Guests</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in upcoming_reservations %}
                            {% include "venues/partials/_reservation_row.html" with r=r %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        
            <h2 class="mt-5">üö™ Guest Arrivals</h2>
            
            <div class="table-responsive">
                <div class="datatable-controls d-flex justify-content-between mb-2">
                    <div id="special-show-entries-wrapper"></div>
                    <div id="special-search-wrapper"></div>
                </div>
                <table id="specialTable" class="table table-striped table-hover shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Guests</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in arrivals %}
                            {% include "venues/partials/_arrival_row.html" with r=r %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    
        </div>

        <!-- History Tab -->
        <div id="history">
            <div class="table-responsive">
                <div class="datatable-controls d-flex justify-content-between mb-2">
                    <div id="history-show-entries-wrapper"></div>
                    <div id="history-search-wrapper"></div>
                </div>
                <table id="pastTable" class="table table-striped table-hover shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Guests</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in past_reservations %}
                        <tr>
                            <td>{{ r.user.username }}</td>
                            <td>{{ r.date }}</td>
                            <td>{{ r.time }}</td>
                            <td>{{ r.guests }}</td>
                            <td>
                                <span class="badge 
                                    {% if r.status == 'pending' %}bg-warning text-dark
                                    {% elif r.status == 'accepted' %}bg-success
                                    {% else %}bg-danger{% endif %}">
                                    {{ r.status|capfirst }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-pane">
            {% include 'venues/_analytics_tab_content.html' %}
        </div>

        <div id="manage-venue" class="tab-pane">
            {% include 'venues/_manage_venue.html' %}
        </div>
    </div>
</div>
{% endblock %}
