{% extends 'includes/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="{% static 'venues/venue_dashboard.css' %}">
{% endblock %}

{% block extra_js %}
    <!-- Load dependencies -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script>
    $(document).ready(function () {
        // Initialize DataTables
        $('#upcomingTable, #pastTable, #specialTable').DataTable({
            lengthChange: true,
            searching: true,
        });

        // Move DataTables controls into custom wrappers after initialization
        setTimeout(() => {
            $('#upcoming-show-entries-wrapper').append($('#upcomingTable_length').detach());
            $('#upcoming-search-wrapper').append($('#upcomingTable_filter').detach());

            $('#history-show-entries-wrapper').append($('#pastTable_length').detach());
            $('#history-search-wrapper').append($('#pastTable_filter').detach());

            $('#special-show-entries-wrapper').append($('#specialTable_length').detach());
            $('#special-search-wrapper').append($('#specialTable_filter').detach());
        }, 100);

        // Accept/reject button animation with redirect
        $(document).on('click', '.btn-accept-reservation', function (e) {
            e.preventDefault();
            const url = this.href;
            const $row = $(this).closest('tr');

            $row.addClass('fade-out-slide');

            setTimeout(() => {
                window.location.href = url;
            }, 400); // Should match CSS animation duration
        });

        // Tab switching logic
        $('.tabs button').on('click', function () {
            const tabId = $(this).data('tab');

            // Remove active classes
            $('.tabs button').removeClass('active');
            $('.tab-content > div, #analytics-tab').removeClass('active');

            // Add active class to selected tab
            $(this).addClass('active');

            if (tabId === 'analytics') {
                $('#analytics-tab').addClass('active');
                loadAnalyticsPartial($('#venue-dashboard').data('venue-id'), $('#group').val() || 'daily');
            } else {
                $('#' + tabId).addClass('active');
            }
        });

        // Analytics grouping change listener (delegated)
        $(document).on('change', '#group', function () {
            loadAnalyticsPartial($('#venue-dashboard').data('venue-id'), $(this).val());
        });

        // Load analytics data via AJAX and update UI
        function loadAnalyticsPartial(venueId, grouping = 'daily') {
            fetch(`/venues/${venueId}/analytics/partial/?group=${grouping}`, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                $('#total-visits').text(data.total_visits);
                $('#avg-daily-visits').text(data.avg_daily_visits);
                $('#peak-visits').text(data.peak_visits);
                $('#total-reservations').text(data.total_reservations);

                const figure = JSON.parse(data.figure);
                Plotly.newPlot('analytics-chart', figure.data, figure.layout, data.config);
            })
            .catch(err => {
                console.error('Error loading analytics:', err);
                $('#analytics-chart').html('<div class="alert alert-warning">Failed to load analytics data.</div>');
            });
        }

        // If Analytics tab is initially active, load analytics data immediately
        if ($('#analytics-tab').hasClass('active')) {
            loadAnalyticsPartial($('#venue-dashboard').data('venue-id'), $('#group').val() || 'daily');
        }
    });
    </script>
{% endblock %}

{% block title %}Venue Dashboard{% endblock %}

{% block content %}
<div class="container mt-5" id="venue-dashboard" data-venue-id="{{ venue.id }}">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">{{ venue.name }}</h1>
        <form action="{% url 'toggle_venue_full' venue.id %}" method="post" class="venue-status-toggle">
            {% csrf_token %}
            {% if venue.is_full %}
                <span class="badge bg-danger me-2">🚫 Full</span>
                <button type="submit" class="btn btn-outline-success btn-sm mark-availability">✅ Mark as Available</button>
            {% else %}
                <span class="badge bg-success me-2">✅ Available</span>
                <button type="submit" class="btn btn-outline-danger btn-sm mark-availability">🚫 Mark as Full</button>
            {% endif %}
        </form>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button type="button" class="active" data-tab="requests">Reservation Requests & Guest Arrivals</button>
        <button type="button" data-tab="history">Reservation History</button>
        <button type="button" data-tab="analytics">📊 Analytics</button>
    </div>

    <!-- Tab Contents -->
    <div class="tab-content">
        <!-- Requests Tab -->
        <div id="requests" class="active">
            <h2 class="mt-4">📝 Pending Reservation Requests</h2>
            {% if upcoming_reservations %}
                <div class="table-responsive">
                    <div class="datatable-controls d-flex justify-content-between mb-2">
                        <div id="upcoming-show-entries-wrapper"></div>
                        <div id="upcoming-search-wrapper"></div>
                    </div>
                    <table id="upcomingTable" class="table table-striped table-hover shadow-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Party Size</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in upcoming_reservations %}
                            <tr>
                                <td>{{ r.user.username }}</td>
                                <td>{{ r.date }}</td>
                                <td>{{ r.time }}</td>
                                <td>{{ r.party_size }}</td>
                                <td>
                                    <span class="badge 
                                        {% if r.status == 'pending' %}bg-warning text-dark
                                        {% elif r.status == 'accepted' %}bg-success
                                        {% else %}bg-danger{% endif %}">
                                        {{ r.status|capfirst }}
                                    </span>
                                </td>
                                <td>
                                    {% if r.status == 'pending' %}
                                        <a href="{% url 'update_reservation_status' r.id 'accepted' %}" class="btn btn-success btn-sm me-1 btn-accept-reservation">✅ Accept</a>
                                        <a href="{% url 'update_reservation_status' r.id 'rejected' %}" class="btn btn-danger btn-sm btn-accept-reservation">❌ Reject</a>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info mt-4">No upcoming reservation requests.</div>
            {% endif %}

            <h2 class="mt-5">🚪 Guest Arrivals</h2>
            {% if arrivals %}
                <div class="table-responsive">
                    <div class="datatable-controls d-flex justify-content-between mb-2">
                        <div id="special-show-entries-wrapper"></div>
                        <div id="special-search-wrapper"></div>
                    </div>
                    <table id="specialTable" class="table table-striped table-hover shadow-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>Customer</th>
                                <th>Request Date</th>
                                <th>Details</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in arrivals %}
                            <tr>
                                <td>{{ r.user.username }}</td>
                                <td>{{ r.date }}</td>
                                <td>{{ r.details }}</td>
                                <td>
                                    <span class="badge 
                                        {% if r.arrival_status == 'pending' %}bg-warning text-dark
                                        {% elif r.arrival_status == 'checked_in' %}bg-success
                                        {% else %}bg-danger{% endif %}">
                                        {{ r.arrival_status|capfirst }}
                                    </span>
                                </td>
                                <td>
                                    {% if r.arrival_status == 'pending' %}
                                        <a href="{% url 'update_arrival_status' r.id 'checked_in' %}" class="btn btn-success btn-sm me-1">✅ Checked-in</a>
                                        <a href="{% url 'update_arrival_status' r.id 'no_show' %}" class="btn btn-danger btn-sm">❌ No-show</a>
                                        <a href="{% url 'edit_reservation_status' r.id %}" class="btn btn-sm btn-edit-status">Edit Status</a>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info mt-4">No expected arrivals at the moment.</div>
            {% endif %}
        </div>

        <!-- History Tab -->
        <div id="history">
            {% if past_reservations %}
                <div class="table-responsive">
                    <div class="datatable-controls d-flex justify-content-between mb-2">
                        <div id="history-show-entries-wrapper"></div>
                        <div id="history-search-wrapper"></div>
                    </div>
                    <table id="pastTable" class="table table-striped table-hover shadow-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Party Size</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in past_reservations %}
                            <tr>
                                <td>{{ r.user.username }}</td>
                                <td>{{ r.date }}</td>
                                <td>{{ r.time }}</td>
                                <td>{{ r.party_size }}</td>
                                <td>
                                    <span class="badge 
                                        {% if r.status == 'pending' %}bg-warning text-dark
                                        {% elif r.status == 'accepted' %}bg-success
                                        {% else %}bg-danger{% endif %}">
                                        {{ r.status|capfirst }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info mt-4">No past reservations.</div>
            {% endif %}
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-pane">
            {% include 'venues/_analytics_tab_content.html' %}
        </div>
    </div>
</div>
{% endblock %}
