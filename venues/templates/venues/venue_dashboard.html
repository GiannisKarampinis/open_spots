{% extends 'includes/base.html' %}
{% load static %}
{% load date_filters %}
{% load i18n %}


{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="{% static 'venues/venue_dashboard.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{% static 'venues/flatpickr_overriden_styles.css' %}">
{% endblock %}

{% block extra_js %}
    <!-- Load dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.257.0/dist/umd/lucide.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <!-- Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="{% static 'venues/js/analytics-tabs.js' %}"></script>
    <script src="{% static 'venues/js/notifications.js' %}"></script>
    <script src="{% static 'venues/js/reservation-actions.js' %}"></script>
    <script src="{% static 'venues/js/tables.js' %}"></script>
    <script src="{% static 'venues/js/utils.js' %}"></script>
    <script src="{% static 'venues/js/websocket.js' %}"></script>
    <script src="{% static 'venues/js/row-renderer.js' %}"></script>
    <script src="{% static 'venues/js/main.js' %}"></script>
    <script src="{% static 'venues/js/textarea-autoresize.js' %}"></script>
    <script src="{% static 'venues/js/image-preview.js' %}"></script>
    <script src="{% static 'venues/js/date-range-picker.js' %}"></script>
    
{% endblock %}

{% block title %}{% trans "Venue Dashboard" %}{% endblock %}

{% block content %}
<div class="container mt-5" id="venue-dashboard" data-venue-id="{{ venue.id }}">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">{{ venue.name }}</h1>
        <form action="{% url 'toggle_venue_full' venue.id %}" method="post" class="venue-status-toggle">
            {% csrf_token %}
            {% if venue.is_full %}
                <span class="badge bg-danger me-2">ðŸš« {% trans "Full" %}</span>
                <button type="submit" class="btn btn-outline-success btn-sm mark-availability">âœ… {% trans "Mark as Available" %}</button>
            {% else %}
                <span class="badge bg-success me-2">âœ… {% trans "Available" %}</span>
                <button type="submit" class="btn btn-outline-danger btn-sm mark-availability">ðŸš« {% trans "Mark as Full" %}</button>
            {% endif %}
        </form>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button type="button" class="active d-flex align-items-center gap-1" data-tab="requests">
            <span data-lucide="file-text"></span> {% trans "Reservation Requests & Guest Arrivals" %}
            <span id="notification-container" class="position-relative ms-2">
                <span data-lucide="bell"></span>
                <span id="notification-badge" 
                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                    style="display:none; font-size:0.7rem;">
                    0
                </span>
            </span>
        </button>

        <button type="button" data-tab="history">
            <span data-lucide="clipboard-list"></span> {% trans "Reservation History" %}
        </button>
        <button type="button" data-tab="analytics">
            <span data-lucide="bar-chart-2"></span> {% trans "Analytics" %}
        </button>
        <button type="button" data-tab="manage-venue">
            <span data-lucide="settings-2"></span> {% trans "Manage Venue" %}
        </button>
    </div>

    <!-- Tab Contents -->
    <div class="tab-content">
        <!-- Requests Tab -->
        <div id="requests" class="active">
            {% include 'venues/partials/_date_range_picker.html' with target_tab="requestsTab" %}

            <h2 class="mt-4"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alarm-clock-icon lucide-alarm-clock"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M5 3 2 6"/><path d="m22 6-3-3"/><path d="M6.38 18.7 4 21"/><path d="M17.64 18.67 20 21"/></svg>
                {% trans "Pending Reservation Requests" %}</h2>
            
            <div class="table-responsive">
                <div class="datatable-controls d-flex justify-content-between mb-2">
                    <div id="upcoming-show-entries-wrapper"></div>
                    <div id="upcoming-search-wrapper"></div>
                </div>
                <table id="upcomingTable" class="table table-striped table-hover shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>{% trans "Customer" %}</th>
                            <th>{% trans "Date" %}</th>
                            <th>{% trans "Time" %}</th>
                            <th>{% trans "Guests" %}</th>
                            <th>{% trans "Status" %}</th>
                            <th>{% trans "Action" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in upcoming_reservations %}
                            {% include "venues/partials/_reservation_row.html" with r=r %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        
            <h2 class="mt-5"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alarm-clock-check-icon lucide-alarm-clock-check"><circle cx="12" cy="13" r="8"/><path d="M5 3 2 6"/><path d="m22 6-3-3"/><path d="M6.38 18.7 4 21"/><path d="M17.64 18.67 20 21"/><path d="m9 13 2 2 4-4"/></svg> 
                {% trans "Guest Arrivals & Cancellations" %}</h2>
            
            <div class="table-responsive">
                <div class="datatable-controls d-flex justify-content-between mb-2">
                    <div id="special-show-entries-wrapper"></div>
                    <div id="special-search-wrapper"></div>
                </div>
                <table id="specialTable" class="table table-striped table-hover shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>{% trans "Customer" %}</th>
                            <th>{% trans "Date" %}</th>
                            <th>{% trans "Time" %}</th>
                            <th>{% trans "Guests" %}</th>
                            <th>{% trans "Status" %}</th>
                            <th>{% trans "Action" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in arrivals %}
                            {% include "venues/partials/_arrival_row.html" with r=r %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    
        </div>

        <!-- History Tab -->
        <div id="history">
            {% include 'venues/partials/_date_range_picker.html' with target_tab="historyTab" %}

            <div class="table-responsive">
                <div class="datatable-controls d-flex justify-content-between mb-2">
                    <div id="history-show-entries-wrapper"></div>
                    <div id="history-search-wrapper"></div>
                </div>
                <table id="pastTable" class="table table-striped table-hover shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>{% trans "Customer" %}</th>
                            <th>{% trans "Date" %}</th>
                            <th>{% trans "Time" %}</th>
                            <th>{% trans "Guests" %}</th>
                            <th>{% trans "Status" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in past_reservations %}
                        <tr>
                            <td>{{ r.user.username }}</td>
                            <td>{{ r.date|format_date_display }}</td>
                            <td>{{ r.time|format_time_display }}</td>
                            <td>{{ r.guests }}</td>
                            <td>
                                <span class="badge 
                                    {% if r.status == 'pending' %}bg-warning text-dark
                                    {% elif r.status == 'accepted' %}bg-success
                                    {% else %}bg-danger{% endif %}">
                                    {{ r.status|capfirst }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-pane">
            {% include 'venues/_analytics_tab_content.html' %}
        </div>

        <div id="manage-venue" class="tab-pane">
            {% include 'venues/_manage_venue.html' %}
        </div>
    </div>
</div>
{% endblock %}
