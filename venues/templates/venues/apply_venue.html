{% extends 'includes/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Apply to Register a Venue" %}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'venues/apply_venue.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/verify_code.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/partial_signup.css' %}">
{% endblock %}

{% block content %}

<div class="apply-container">

  <div class="form-header">
    <h2>{% trans "Apply to Register Your Venue" %}</h2>
    <p class="form-intro">
      {% trans "Fields marked with" %} <span class="text-danger">*</span>
      {% trans "are required. You must also verify your admin email before submitting the application." %}
    </p>
  </div>

  {% if form.non_field_errors %}
    <ul class="errorlist" style="visibility:hidden;">
      {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" novalidate> 
    {% csrf_token %}

    
    <div class="form-section">
      <div class="section-header">
        <h3 class="section-title">{% trans "Venue Owner" %}</h3>
        <p class="section-subtitle">{% trans "Owner account details and email verification." %}</p>
      </div>

      <div class="section-body">
        {% include "accounts/partial_signup.html" with form=form email_verified=email_verified %}

    {% for field in form %}
      {% if field.name != 'admin_username' and field.name != 'admin_email' and field.name != 'password1' and field.name != 'password2' %}
        <div class="form-group">
          <label for="{{ field.id_for_label }}">
            {% trans field.label %}
            {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>

          {{ field }}

          {% if field.name == 'location' %}
            <div id="locationSuggestions" class="location-suggestions" style="display:none;"></div>
          {% endif %}

          <div class="field-error-slot" id="err-{{ field.id_for_label }}">
            {% if field.errors %}
              <ul class="errorlist">
                {% for error in field.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <ul class="errorlist" style="visibility:hidden;">
                <li>&nbsp;</li>
              </ul>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}

    <div id="submitHintSlot" class="field-error-slot" style="margin-top:10px;">
      <ul id="submitHint" class="errorlist is-hidden"><li>&nbsp;</li></ul>
    </div>

    <div id="submitGuardWrap" style="position:relative;">
      <button id="submitApplicationBtn"
              type="submit"
              name="action"
              value="submit_application"
              class="btn primary-btn mt-3"
              {% if not email_verified %}disabled{% endif %}>
        {% trans "Submit Application" %}
      </button>
    </div>
  </form>
</div>

<script>
;(() => {
  const input = document.getElementById("id_location");
  if (!input) return;

  // Wrap suggestions under the same form-group
  const formGroup = input.closest(".form-group");
  formGroup.style.position = "relative";

  let box = document.getElementById("locationSuggestions");
  if (!box) {
    box = document.createElement("div");
    box.id = "locationSuggestions";
    box.className = "location-suggestions";
    box.style.display = "none";
    formGroup.appendChild(box);
  }

  let timer = null;
  let abort = null;

  function hide() {
    box.style.display = "none";
    box.innerHTML = "";
  }

  function show(items) {
    box.innerHTML = "";
    items.forEach(it => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = it.display_name;
      btn.addEventListener("click", () => {
        input.value = it.display_name;
        hide();
      });
      box.appendChild(btn);
    });
    box.style.display = items.length ? "block" : "none";
  }

  async function search(q) {
    if (abort) abort.abort();
    abort = new AbortController();

    const url = new URL("https://nominatim.openstreetmap.org/search");
    url.searchParams.set("format", "json");
    url.searchParams.set("addressdetails", "1");
    url.searchParams.set("limit", "6");
    url.searchParams.set("countrycodes", "gr");
    url.searchParams.set("q", q);

    const res = await fetch(url.toString(), {
      signal: abort.signal,
      headers: {
        // not always required in browsers, but harmless
        "Accept": "application/json"
      }
    });

    if (!res.ok) return [];
    return await res.json();
  }

  input.addEventListener("input", () => {
    const q = input.value.trim();
    if (q.length < 3) return hide();

    clearTimeout(timer);
    timer = setTimeout(async () => {
      try {
        const items = await search(q);
        show(items);
      } catch (e) {
        // aborted requests are normal
      }
    }, 250);
  });

  document.addEventListener("click", (e) => {
    if (!formGroup.contains(e.target)) hide();
  });

  input.addEventListener("blur", () => {
    // small delay so clicks register
    setTimeout(hide, 150);
  });
})();
</script>

<script>
(() => {
  const form = document.querySelector(".apply-container form");
  if (!form) return;

  function hideErrorForField(fieldEl) {
    const group = fieldEl.closest(".form-group");
    if (!group) return;

    // IMPORTANT: only the errorlist inside the reserved slot
    const slot = group.querySelector(".field-error-slot");
    if (!slot) return;

    const list = slot.querySelector("ul.errorlist");
    if (!list) return;

    list.classList.add("is-hidden");

    // remove red invalid styling (if you set it)
    fieldEl.removeAttribute("aria-invalid");
    fieldEl.classList.remove("is-invalid");
  }

  // For text-like inputs: hide on input
  form.addEventListener("input", (e) => {
    const el = e.target;
    if (!el.matches("input, textarea")) return;
    hideErrorForField(el);
  });

  // For selects: hide on change
  form.addEventListener("change", (e) => {
    const el = e.target;
    if (!el.matches("select")) return;
    hideErrorForField(el);
  });
})();
</script>

<script>
(() => {
  const submitBtn = document.getElementById("submitApplicationBtn");
  const wrap = document.getElementById("submitGuardWrap");
  const hint = document.getElementById("submitHint");

  // reuse your existing verify popover function if it exists
  // openPopover() is already defined in your big script
  function showSubmitHint(msg) {
    if (!hint) return;
    hint.innerHTML = `<li>${msg}</li>`;
    hint.classList.remove("is-hidden");
  }

  function hideSubmitHint() {
    if (!hint) return;
    hint.classList.add("is-hidden");
  }

  function ensureGuard() {
    if (!submitBtn || !wrap) return;

    // remove existing guard if any
    const existing = wrap.querySelector(".submit-guard");
    if (existing) existing.remove();

    if (submitBtn.disabled) {
      const guard = document.createElement("div");
      guard.className = "submit-guard";
      guard.addEventListener("click", () => {
        showSubmitHint("{% trans 'Please verify your admin email before submitting.' %}");
        // optional: open verify popover for convenience
        if (typeof openPopover === "function") openPopover();
      });
      wrap.appendChild(guard);
    } else {
      hideSubmitHint();
    }
  }

  // initial
  ensureGuard();

  // if you enable/disable submit in JS (after verification), call ensureGuard again.
  // easiest: observe changes to disabled attribute
  const obs = new MutationObserver(ensureGuard);
  obs.observe(submitBtn, { attributes: true, attributeFilter: ["disabled"] });

})();
</script>

{% endblock %}