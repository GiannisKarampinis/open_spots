{% extends 'includes/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Apply to Register a Venue" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'venues/apply_venue.css' %}">
    <link rel="stylesheet" href="{% static 'accounts/verify_code.css' %}">
    <link rel="stylesheet" href="{% static 'accounts/partial_signup.css' %}">
{% endblock %}

{% block content %}

<div class="apply-container">


  <div class="form-header">
    <h2>{% trans "Apply to Register Your Venue" %}</h2>
    <p class="form-intro">
      {% trans "Fields marked with" %} <span class="text-danger">*</span>
      {% trans "are required. You must also verify your admin email before submitting the application." %}
    </p>
  </div>


  {% comment %} 1.Errors not binded to a particular field {% endcomment %}
  {% if form.non_field_errors %}
    <ul class="errorlist" style="visibility:hidden;">
      {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  {% endif %}



  <form id="apply-venue-form" method="post" novalidate> 
  
    {% csrf_token %}

    <div class="form-section">
  
      {% comment %} 2. User data that will used while creating the venue owner {% endcomment %}
      <div class="section-body">
        {% include "accounts/partial_signup.html" with form=form email_verified=email_verified %}
      </div>
  
    </div>
    
    {% for field in form %}
      {% comment %} The following line is maintenance heavy! {% endcomment %}
      {% if field.name != 'admin_username' and field.name != 'admin_email' and field.name != 'password1' and field.name != 'password2' and field.name != 'admin_firstname' and field.name != 'admin_lastname' and field.name != 'admin_phone' %}
        <div class="form-group">
          <label for="{{ field.id_for_label }}">
            {% trans field.label %}
            {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>

          {{ field }}

          {% if field.name == 'location' %}
            <div id="locationSuggestions" class="location-suggestions" style="display:none;"></div>
          {% endif %}

          <div class="field-error-slot" id="err-{{ field.id_for_label }}">
            {% if field.errors %}
              <ul class="errorlist">
                {% for error in field.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <ul class="errorlist" style="visibility:hidden;">
                <li>&nbsp;</li>
              </ul>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}

    <div id="submitHintSlot" class="field-error-slot" style="margin-top:10px;">
      <ul id="submitHint" class="errorlist is-hidden"><li>&nbsp;</li></ul>
    </div>

    <div id="submitGuardWrap" style="position:relative;">
      <button id="submitApplicationBtn"
              type="submit"
              name="action"
              value="submit_application"
              class="btn primary-btn mt-3"
              {% if not email_verified %}disabled{% endif %}>
        {% trans "Submit Application" %}
      </button>
    </div>
  </form>
</div>

<script>
;(() => {
  const input = document.getElementById("id_location");
  if (!input) return;

  // Wrap suggestions under the same form-group
  const formGroup = input.closest(".form-group");
  formGroup.style.position = "relative";

  let box = document.getElementById("locationSuggestions");
  if (!box) {
    box = document.createElement("div");
    box.id = "locationSuggestions";
    box.className = "location-suggestions";
    box.style.display = "none";
    formGroup.appendChild(box);
  }

  let timer = null;
  let abort = null;

  function hide() {
    box.style.display = "none";
    box.innerHTML = "";
  }

  function show(items) {
    box.innerHTML = "";
    items.forEach(it => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = it.display_name;
      btn.addEventListener("click", () => {
        input.value = it.display_name;
        hide();
      });
      box.appendChild(btn);
    });
    box.style.display = items.length ? "block" : "none";
  }

  async function search(q) {
    if (abort) abort.abort();
    abort = new AbortController();

    const url = new URL("https://nominatim.openstreetmap.org/search");
    url.searchParams.set("format", "json");
    url.searchParams.set("addressdetails", "1");
    url.searchParams.set("limit", "6");
    url.searchParams.set("countrycodes", "gr");
    url.searchParams.set("q", q);

    const res = await fetch(url.toString(), {
      signal: abort.signal,
      headers: {
        // not always required in browsers, but harmless
        "Accept": "application/json"
      }
    });

    if (!res.ok) return [];
    return await res.json();
  }

  input.addEventListener("input", () => {
    const q = input.value.trim();
    if (q.length < 3) return hide();

    clearTimeout(timer);
    timer = setTimeout(async () => {
      try {
        const items = await search(q);
        show(items);
      } catch (e) {
        // aborted requests are normal
      }
    }, 250);
  });

  document.addEventListener("click", (e) => {
    if (!formGroup.contains(e.target)) hide();
  });

  input.addEventListener("blur", () => {
    // small delay so clicks register
    setTimeout(hide, 150);
  });
})();
</script>
{% endblock %}



{% block extra_js %}
  {% comment %} 
    
    This bock bridges Django (server-side) with the email verifier JS (client-side)
    by injecting config data like URLs and translated strings.
    Our accounts/js/venue_email_verify.js cannot use Django template tags directly
    like {% url %} or {% trans %} because it is a static file served as-is. The 
    following script block is a workaround to pass the required data from Django 
    to the JS code.

  {% endcomment %}
  <script>
    window.venueVerifyConfig = {
      sendUrl:    "{% url 'ajax_send_venue_code' %}",
      verifyUrl:  "{% url 'ajax_verify_venue_code' %}",
      i18n: {
        verifyEmail:    "{% trans 'Verify Email' %}",
        verified:       "{% trans 'Verified' %}",
        enterEmailFirst: "{% trans 'Enter admin email first.' %}",
        failedSend:     "{% trans 'Failed to send code.' %}",
        codeSent:       "{% trans 'Code sent. Check your inbox.' %}",
        enterValidCode: "{% trans 'Enter a valid 6-digit code.' %}",
        verifyFailed:   "{% trans 'Verification failed.' %}",
        verifiedOk:     "{% trans 'Email verified ✅' %}"
      }
    };
  </script>
  
  {% comment %} Email Verifier JS script: {% endcomment %}
  <script src="{% static 'accounts/js/venue_email_verify.js' %}"></script> 
  
  {% comment %} Form Validation common code with signup.html {% endcomment %}
  <script src="{% static 'common/js/form_validation.js' %}"></script>
  
  <script>
  {% comment %} 
    attachSignupLikeValidation() runs the same checks with signup.html
    to keep validation fully consistent accross the different signup 
    workflows of openspots. The validator (common/js/form_validation.js)
    only knows about generic field types (like "username", "email", etc)
    so we need to map our venue application form fields to these types.
    So the JS expects:
      <input name="admin_username" ...>
      <input name="admin_email" ...>
    If our inputs use any other name, validation will silently not run. 
  {% endcomment %}
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof attachSignupLikeValidation === "function") {// JS function exists and it is properly exposed  
        attachSignupLikeValidation("apply-venue-form", {
          admin_username:   "username",
          admin_email:      "email",
      }); 
    }
    });
  </script>

  {% comment %}
    Submit Guard config:
    This script places an invisible clickable overlay on top of a 
    disabled submit button, so when the user clicks it, they get a 
    clear message + shortcut to email verification, instead of 
    “nothing happens”.
  {% endcomment %}
  <script src="{% static 'venues/js/ApplyVenue_submitGuard.js' %}"></script>
  <script>
    window.submitGuardConfig = {
      submitBtnId:  "submitApplicationBtn",
      wrapId:       "submitGuardWrap",
      hintId:       "submitHint",
      openVerifyBtnId: "openVerifyPopover",
      message:      "{% trans 'Please verify your admin email before submitting.' %}"
    };
  </script>


{% endblock %}
