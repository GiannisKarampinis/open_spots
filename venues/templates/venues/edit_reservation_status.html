{% extends "includes/base.html" %}
{% load static %}
{% load date_filters %}
{% load i18n %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'venues/edit_reservation_status.css' %}">
{% endblock %}

{% block content %}
<!-- Edit Status Modal -->
<div id="editStatusModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-content">
        <button type="button" class="modal-close" aria-label="Close modal">&times;</button>

        <h2 id="editTitle">{% trans "Edit Reservation Status" %}</h2>

        <div class="reservation-info">
            <p><strong>{% trans "Customer:" %}</strong> {{ reservation.user.username }}</p>
            <p><strong>{% trans "Date:" %}</strong> {{ reservation.date|format_date_display }}</p>
            <p><strong>{% trans "Time:" %}</strong> {{ reservation.time|format_time_display }}</p>
            <p><strong>{% trans "Party Size:" %}</strong> {{ reservation.guests }}</p>
        </div>

        <form id="updateStatusForm" method="post" novalidate>
            {% csrf_token %}
            {{ form.non_field_errors }}

            <div class="mb-3">
                {{ form.arrival_status.label_tag }}
                {{ form.arrival_status }}
                {% for error in form.arrival_status.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="form-check mb-3">
                <label class="form-check-label">
                    {{ form.move_to_requests }} {{ form.move_to_requests.label }}
                </label>
                {% for error in form.move_to_requests.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">{% trans "Update Status" %}</button>
                <a href="{% url 'venue_dashboard' reservation.venue.id %}" class="btn btn-secondary modal-close">{% trans "Cancel" %}</a>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-describedby="confirmDesc">
    <div class="modal-content">
        <h2 id="confirmTitle">{% trans "Confirm Update" %}</h2>
        <p id="confirmDesc">{% trans "Are you sure you want to update the reservation status?" %}</p>
        <div class="d-flex">
            <button id="confirmCancel" type="button" class="btn btn-secondary">{% trans "Cancel" %}</button>
            <button id="confirmOk" type="button" class="btn btn-primary">{% trans "Yes, Update" %}</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const editModal = document.getElementById('editStatusModal');
    const confirmModal = document.getElementById('confirmModal');
    const closeButtons = editModal.querySelectorAll('.modal-close');

    editModal.classList.add('show');

    closeButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = "{% url 'venue_dashboard' reservation.venue.id %}";
        });
    });

    editModal.addEventListener('click', (e) => {
        if (e.target === editModal) {
            window.location.href = "{% url 'venue_dashboard' reservation.venue.id %}";
        }
    });

    const confirmCancel = document.getElementById('confirmCancel');
    const confirmOk = document.getElementById('confirmOk');
    const updateForm = document.getElementById('updateStatusForm');

    updateForm.addEventListener('submit', (e) => {
        e.preventDefault();
        confirmModal.classList.add('show');
    });

    confirmCancel.addEventListener('click', () => {
        confirmModal.classList.remove('show');
    });

    confirmOk.addEventListener('click', () => {
        confirmModal.classList.remove('show');
        updateForm.submit();
    });

    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
            confirmModal.classList.remove('show');
        }
    });
});
</script>
{% endblock %}
