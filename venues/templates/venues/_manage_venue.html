{% load i18n %}

<div class="container mt-5" id="manage-venue-form">
  <form method="POST" enctype="multipart/form-data" class="venue-form-card"
        action="{% url 'submit_venue_update' venue.id %}">
    {% csrf_token %}

    <!-- ðŸŸ© NON-SENSITIVE SECTION -->
    <div class="section-card mb-4">
      <button class="section-header" type="button"
              data-bs-target="#nonSensitiveSection" aria-expanded="true">
        <h5 class="mb-0">{% trans "Publicly Adjustable Information" %}</h5>
        <span class="toggle-icon">â–¾</span>
      </button>

      <div id="nonSensitiveSection" class="collapse show section-body">
        <label for="available_tables">{% trans "Available Tables (Today)" %}</label>
        <div class="grid">
          <div>
            <input type="number" name="available_tables" id="available_tables"
                   value="{{ venue.available_tables }}" min="0" class="form-input">
          </div>
        </div>

        <!-- Image Sequence -->
          <div class="mt-4">
            <label>{% trans "Image Display Order" %}</label>
            <p class="small text-muted mb-2">{% trans "Drag and drop to change the order of images as they appear publicly." %}</p>
            <div id="sortable-image-sequence" class="image-sequence-grid">
              {% for img in venue.images.all %}
                <div class="sortable-thumb" data-id="{{ img.id }}">
                  <img src="{{ img.image.url }}" alt="Venue Image" width="100">
                </div>
              {% empty %}
                <p class="text-muted">{% trans "No images uploaded yet." %}</p>
              {% endfor %}
            </div>
            <input type="hidden" name="image_sequence" id="image_sequence" value="">
          </div>

      </div>
    </div>

    <!-- ðŸ”’ SENSITIVE SECTION -->
    <div class="section-card mb-4">
      <button class="section-header" type="button"
              data-bs-target="#sensitiveSection" aria-expanded="false">
        <h5 class="mb-0">{% trans "Sensitive & Contact Information" %}</h5>
        <span class="toggle-icon">â–¸</span>
      </button>

      <div id="sensitiveSection" class="collapse section-body">
        <div class="grid">
          <div>
            <label for="name">{% trans "Venue Name" %}</label>
            <input type="text" name="name" id="name" value="{{ venue.name }}" class="form-input" required>
          </div>
          <div>
            <label for="kind">{% trans "Type" %}</label>
            <select name="kind" id="kind" class="form-input">
              {% for key, value in venue.VENUE_TYPES %}
                <option value="{{ key }}" {% if venue.kind == key %}selected{% endif %}>
                  {% trans value %}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div>
          <label for="location">{% trans "Location" %}</label>
          <input type="text" name="location" id="location" value="{{ venue.location }}" class="form-input" required>
        </div>

        <div>
          <label for="description">{% trans "Description" %}</label>
          <textarea name="description" id="description" rows="4" class="form-input">{{ venue.description }}</textarea>
        </div>

        <div class="grid">
          <div>
            <label for="email">{% trans "Email" %}</label>
            <input type="email" name="email" id="email" value="{{ venue.email }}" class="form-input">
          </div>
          <div>
            <label for="phone">{% trans "Phone" %}</label>
            <input type="text" name="phone" id="phone" value="{{ venue.phone }}" class="form-input">
          </div>
        </div>

        <div class="file-upload-group">
          <div id="venue-preview" class="file-preview">
            {% for img in venue.images.all %}
              <div class="thumb-wrapper" data-existing="true" data-id="{{ img.id }}">
                <img src="{{ img.image.url }}" width="80">
                <button type="button" class="remove-btn">&times;</button>
              </div>
            {% empty %}
              {% trans "No files selected" %}
            {% endfor %}
          </div>

          <label class="custom-file-btn">
            {% trans "Select Venue Images" %}
            <input type="file" name="venue_images" id="venue_images" multiple hidden>
          </label>
        </div>

        <div class="file-upload-group">
          <div id="menu-preview" class="file-preview">
            {% for img in venue.menu_images.all %}
              <div class="thumb-wrapper" data-existing="true" data-id="{{ img.id }}">
                <img src="{{ img.image.url }}" width="80">
                <button type="button" class="remove-btn">&times;</button>
              </div>
            {% empty %}
              {% trans "No files selected" %}
            {% endfor %}
          </div>

          <label class="custom-file-btn">
            {% trans "Select Menu Images" %}
            <input type="file" name="menu_images" id="menu_images" multiple hidden>
          </label>
        </div>

        <button type="submit" class="btn-edit-status">{% trans "Submit for Approval" %}</button>
      </div>
    </div>
  </form>
</div>

<!-- ---------- JS: no Bootstrap required ---------- -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".section-header").forEach(header => {
    // support either data-bs-target or data-target
    const rawTarget = header.getAttribute("data-bs-target") || header.getAttribute("data-target") || header.dataset.bsTarget || header.dataset.target;
    if (!rawTarget) return;
    const target = document.querySelector(rawTarget);
    if (!target) return;

    // initialize state based on presence of 'show' class
    const initiallyShown = target.classList.contains("show");
    header.setAttribute("aria-expanded", initiallyShown ? "true" : "false");
    const icon = header.querySelector(".toggle-icon");
    if (icon) icon.textContent = initiallyShown ? "â–¾" : "â–¸";
    // ensure initial max-height for shown elements so animation can run later
    if (initiallyShown) {
      target.style.maxHeight = target.scrollHeight + "px";
      // expand to natural size then clear it after a tick
      requestAnimationFrame(() => {
        target.style.maxHeight = "";
      });
    } else {
      target.style.maxHeight = "0";
    }

    function collapseSection() {
      header.setAttribute("aria-expanded", "false");
      if (icon) icon.textContent = "â–¸";
      // animate to 0
      target.style.maxHeight = target.scrollHeight + "px"; // start
      // force reflow
      target.offsetHeight;
      target.style.transition = "max-height 220ms ease";
      target.style.maxHeight = "0";
      target.addEventListener("transitionend", function onEnd() {
        target.classList.remove("show");
        target.style.transition = "";
        target.removeEventListener("transitionend", onEnd);
      });
    }

    function expandSection() {
      header.setAttribute("aria-expanded", "true");
      if (icon) icon.textContent = "â–¾";
      target.classList.add("show");
      target.style.maxHeight = "0";
      // force reflow
      target.offsetHeight;
      target.style.transition = "max-height 220ms ease";
      target.style.maxHeight = target.scrollHeight + "px";
      target.addEventListener("transitionend", function onEnd() {
        target.style.transition = "";
        target.style.maxHeight = "";
        target.removeEventListener("transitionend", onEnd);
      });
    }

    header.addEventListener("click", () => {
      const expanded = header.getAttribute("aria-expanded") === "true";
      if (expanded) collapseSection(); else expandSection();
    });

    // keyboard accessibility
    header.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " " || e.code === "Space") {
        e.preventDefault();
        header.click();
      }
    });
  });
});
</script>

<!-- ---------- CSS ---------- -->
<style>
.section-card {
  border: 1px solid #ddd;
  border-radius: 12px;
  background-color: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  margin: 15px;
  overflow: hidden;
}

.section-header {
  width: 100%;
  text-align: left;
  background: #f8f9fa;
  border: none;
  padding: 0.75rem 1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: background 0.2s ease;
  font-size: larger;
  /* make header focusable styling */
  outline: none;
}
.section-header:focus {
  box-shadow: 0 0 0 3px rgba(0,123,255,0.15);
}
.section-header:hover { background: #eef1f5; }

.section-body {
  overflow: hidden;
  max-height: 0;
  padding: 0 1.25rem;
  border-top: 1px solid #eee;
}
.section-body.show {
  padding: 1rem 1.25rem;
  max-height: none; /* when explicitly set by JS it's cleared after open */
}

.toggle-icon {
  font-size: 1.2rem;
  transition: transform 0.2s ease;
}
.section-header[aria-expanded="true"] .toggle-icon {
  transform: rotate(180deg);
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.form-input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 6px;
}
.btn-edit-status {
  margin-top: 1rem;
  background: #007bff;
  border: none;
  color: #fff;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
}
.btn-edit-status:hover { background: #0056b3; }

/* keep your original image/drag styles if used later */
.image-sequence-grid { display:flex; flex-wrap:wrap; gap:.75rem; border:1px dashed #ccc; padding:.75rem; border-radius:8px; background:#fafafa; }
.sortable-thumb img { width:100px; height:80px; object-fit:cover; border-radius:8px; }
</style>
