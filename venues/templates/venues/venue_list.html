{% extends "includes/base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="{% static 'venues/venue_list.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}

{% block title %}{% trans "Browse Venues" %}{% endblock %}

{% block content %}
<div class="page-container">
<h2>{% trans "Explore & Reserve Your Perfect Spot" %}</h2>

<form method="get" class="filter-form">
    <div class="sticky-wrapper">
        <div class="filter-wrapper sticky-filter">
            <i class="fa-solid fa-filter filter-icon"></i>

            <!-- Kind filter -->
            <select name="kind" id="venue_type" onchange="this.form.submit()">
                <option value="">{% trans "All Venues" %}</option>
                <option value="restaurant" {% if selected_kind == "restaurant" %}selected{% endif %}>
                    {% trans "Restaurants" %}
                </option>

                <!-- NOTE: selecting cafe represents cafes+bars -->
                <option value="cafe" {% if selected_kind == "cafe" or selected_kind == "bar" %}selected{% endif %}>
                    {% trans "Cafes & Bars" %}
                </option>

                <option value="beach_bar" {% if selected_kind == "beach_bar" %}selected{% endif %}>
                    {% trans "Beach Bars" %}
                </option>
                <option value="other" {% if selected_kind == "other" %}selected{% endif %}>
                    {% trans "Other" %}
                </option>
            </select>

            <!-- Availability filter -->
            <select name="availability" id="venue_availability" onchange="this.form.submit()">
                <option value="">{% trans "All" %}</option>
                <option value="available" {% if selected_availability == "available" %}selected{% endif %}>
                    {% trans "Available" %}
                </option>
                <option value="full" {% if selected_availability == "full" %}selected{% endif %}>
                    {% trans "Full" %}
                </option>
            </select>

            {% if selected_kind or selected_availability %}
                <a href="{% url 'venue_list' %}" class="clear-filter-btn">{% trans "Clear" %}</a>
            {% endif %}
        </div>
    </div>
</form>

<!-- Recent Reservation -->
{% if upcoming_reservation %}
<div class="quick-reservation-card">
    <h3>{% trans "Your Next Reservation" %}</h3>
    <div class="reservation-info">
        <strong>{{ upcoming_reservation.venue.name }}</strong><br>
        {{ upcoming_reservation.date|date:"M d, Y" }} {{ upcoming_reservation.time|time:"H:i" }}<br>
        {% if upcoming_reservation.table_number %}
            {% trans "Table" %}: {{ upcoming_reservation.table_number }}
        {% endif %}
    </div>

    {% with first_img=upcoming_reservation.venue.get_first_image %}
        <img
            class="venue-image"
            src="{% if first_img %}{{ first_img.image.url }}{% else %}{% static 'images/venue-placeholder.png' %}{% endif %}"
            alt="{{ upcoming_reservation.venue.name }}"
            onerror="this.style.display='none'">
    {% endwith %}

    <div class="reservation-actions">
        <a href="{% url 'edit_reservation' upcoming_reservation.id %}" class="edit-btn">
            <i class="fa-solid fa-pen-to-square"></i> {% trans "Edit" %}
        </a>
        <a href="{% url 'cancel_reservation' upcoming_reservation.id %}" class="cancel-btn">
            <i class="fa-solid fa-xmark"></i> {% trans "Cancel" %}
        </a>
    </div>
</div>
{% endif %}

<!-- Venue sections -->
{% if selected_kind or selected_availability %}
    {# FILTERED MODE -> GRID + PAGINATION #}
    <h3 class="section-title">
        {% if selected_kind %}
            {% if selected_kind == "cafe" or selected_kind == "bar" %}
                {% trans "Cafes & Bars" %}
            {% else %}
                {{ selected_kind|title }} {% trans "Venues" %}
            {% endif %}
        {% else %}
            {% trans "Venues" %}
        {% endif %}
        {% if selected_availability %} - {{ selected_availability|title }}{% endif %}
    </h3>

    <div class="venue-scroll-container grid-mode">
        {% for venue in venues %}
            <a href="{% url 'venue_detail' venue.id %}" class="venue-link">
                {% include "venues/venue_cards.html" with venue=venue %}
            </a>
        {% empty %}
            <p>{% trans "No venues available." %}</p>
        {% endfor %}
    </div>

    {% if is_paginated %}
    <nav class="pagination">
        {% if page_obj.has_previous %}
            <a class="page-btn"
               href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ page_obj.previous_page_number }}">
                ‹ {% trans "Prev" %}
            </a>
        {% else %}
            <span class="page-btn disabled">‹ {% trans "Prev" %}</span>
        {% endif %}

        {% for num in paginator.page_range %}
            {% if num == page_obj.number %}
                <span class="page-number active">{{ num }}</span>
            {% else %}
                <a class="page-number"
                   href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ num }}">
                    {{ num }}
                </a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <a class="page-btn"
               href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ page_obj.next_page_number }}">
                {% trans "Next" %} ›
            </a>
        {% else %}
            <span class="page-btn disabled">{% trans "Next" %} ›</span>
        {% endif %}
    </nav>
    {% endif %}

{% else %}
    {# DEFAULT MODE -> CATEGORY ROWS #}

    <h3 class="section-title">{% trans "Cafes & Bars" %}</h3>
    <div class="venue-scroll-container">
        {% for venue in venues %}
            {% if venue.kind == "cafe" or venue.kind == "bar" %}
                <a href="{% url 'venue_detail' venue.id %}" class="venue-link">
                    {% include "venues/venue_cards.html" with venue=venue %}
                </a>
            {% endif %}
        {% empty %}
            <p>{% trans "No cafes or bars available." %}</p>
        {% endfor %}
    </div>

    <h3 class="section-title">{% trans "Restaurants" %}</h3>
    <div class="venue-scroll-container">
        {% for venue in venues %}
            {% if venue.kind == "restaurant" %}
                <a href="{% url 'venue_detail' venue.id %}" class="venue-link">
                    {% include "venues/venue_cards.html" with venue=venue %}
                </a>
            {% endif %}
        {% empty %}
            <p>{% trans "No restaurants available." %}</p>
        {% endfor %}
    </div>

    <h3 class="section-title">{% trans "Beach Bars" %}</h3>
    <div class="venue-scroll-container">
        {% for venue in venues %}
            {% if venue.kind == "beach_bar" %}
                <a href="{% url 'venue_detail' venue.id %}" class="venue-link">
                    {% include "venues/venue_cards.html" with venue=venue %}
                </a>
            {% endif %}
        {% empty %}
            <p>{% trans "No beach bars available." %}</p>
        {% endfor %}
    </div>

    <h3 class="section-title">{% trans "Other Venues" %}</h3>
    <div class="venue-scroll-container">
        {% for venue in venues %}
            {% if venue.kind == "other" %}
                <a href="{% url 'venue_detail' venue.id %}" class="venue-link">
                    {% include "venues/venue_cards.html" with venue=venue %}
                </a>
            {% endif %}
        {% empty %}
            <p>{% trans "No other venues available." %}</p>
        {% endfor %}
    </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const scrollContainers = document.querySelectorAll('.venue-scroll-container');

    scrollContainers.forEach(function(scrollContainer) {
        // Only apply horizontal-wheel behavior to horizontal rows (NOT grid)
        if (!scrollContainer.classList.contains('grid-mode')) {
            scrollContainer.addEventListener('wheel', function (e) {
                if (e.deltaY !== 0 && scrollContainer.scrollWidth > scrollContainer.clientWidth) {
                    e.preventDefault();
                    scrollContainer.scrollLeft += e.deltaY;
                }
            }, { passive: false });
        }
    });

    const stickyWrapper = document.querySelector('.sticky-wrapper');
    const observer = new IntersectionObserver(
        ([e]) => stickyWrapper.classList.toggle('is-stuck', e.intersectionRatio < 1),
        { threshold: [1] }
    );
    observer.observe(stickyWrapper);
});
</script>
<div class="page-container">
{% endblock %}
